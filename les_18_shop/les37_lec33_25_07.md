25.07.2025   
## <div style="color: #9000F0">Lesson 38 (Les 37 in the list of Module), Lecture 33</div>    
app "shop".

See <a>Les37-Python Adv_33-25_07.pdf</a>  and  <a>Les37-Python Adv_33---25_07.pdf</a>  

–°–º–æ—Ç—Ä–∏ —Ä–µ–ø—É –ë–∞–Ω–¥—ã–ª–æ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏: https://github.com/viacheslav-bandylo/111124-projects/tree/main

### 24.07.2025 - Les 38 (Les 37 in the list of Module), Lec 33: –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–æ–≤

–ó–ê–õ–û–ì–ò–ù–ò–í–ê–ù–ò–ï –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8000/shop/login/:
```python
{"username": "odnabu", "password": "123"}
```

![img.png](img.png)


### 24.07.2025 - Les 38 (Les 37 in the list of Module), Lec 33: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å JWT

Hanna Kulykovska 12:32
> USERNAME_FIELD = 'email' —É–∫–∞–∑—ã–≤–∞–µ—Ç Django –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å email –≤–º–µ—Å—Ç–æ username –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø:
```python
{"username": "test_user", "password": "test_user_T*T_", "email": "test_user@gde.com"}
```

![img_2.png](img_2.png)
![img_3.png](img_3.png)

–ï–°–¢–¨ –î–û–°–¢–£–ü
![img_4.png](img_4.png)

–†–ê–ó–õ–û–ì–ò–ù–ò–í–ê–ù–ò–ï
![img_5.png](img_5.png)

–ü–û–°–õ–ï –†–ê–ó–õ–û–ì–ò–ù–ò–í–ê–ù–ò–Ø
![img_6.png](img_6.png)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –Ω–æ –Ω–µ —Å–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É:
![img_7.png](img_7.png)
![img_8.png](img_8.png)


---
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
---

---

–ü–æ—á–µ–º—É –º–æ–∂–µ—Ç –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access-—Ç–æ–∫–µ–Ω–∞ –≤ –∫—É–∫–∏.

[ChatGPT](https://chatgpt.com/s/t_6884e176340c8191a9c2deb672e62122)

### –ü—Ä–æ–±–ª–µ–º–∞
–ö–ª—é—á–µ–≤–æ–π —É—á–∞—Å—Ç–æ–∫:
```python
if response.status_code == 401 and b"Token is invalid or expired" in response.content:
```

**üî¥ –ü—Ä–æ–±–ª–µ–º–∞ –≤ —ç—Ç–æ–º —É—Å–ª–æ–≤–∏–∏:**
Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ *–±–∞–π—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞* `"Token is invalid or expired"` –≤ `response.content`. –ù–æ:

* DRF **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç**, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∞—è —Ñ—Ä–∞–∑–∞ –ø–æ–ø–∞–¥—ë—Ç –≤ –æ—Ç–≤–µ—Ç.
* –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –ø–æ –≤–µ—Ä—Å–∏–∏ DRF –∏–ª–∏ `simplejwt`.
* –ú–æ–∂–µ—Ç –±—ã—Ç—å HTML-–æ—Ç–≤–µ—Ç, JSON-–æ—à–∏–±–∫–∞, –∏–ª–∏ –¥—Ä—É–≥–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.

---

### ‚úÖ **–†–µ—à–µ–Ω–∏–µ**

1. **–ù–∞–¥—ë–∂–Ω–µ–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ –∫–æ–¥—É –æ—à–∏–±–∫–∏ –∏ —Ç–∏–ø—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è.**

#### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π `process_response`:

```python
def process_response(self, request, response):
    if response.status_code == 401:
        refresh_token_cookie = request.COOKIES.get('refresh_token')

        if refresh_token_cookie:
            try:
                refresh = RefreshToken(refresh_token_cookie)
                new_access_token = str(refresh.access_token)

                # –û–±–Ω–æ–≤–∏–º –∫—É–∫–∏
                response.set_cookie('access_token', new_access_token, httponly=True, samesite='Lax', secure=False)
                response.set_cookie('refresh_token', str(refresh), httponly=True, samesite='Lax', secure=False)

                # –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî –í–ù–ò–ú–ê–ù–ò–ï: —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω
                return response  # –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –∏ –∫–ª–∏–µ–Ω—Ç –ø—É—Å—Ç—å —Å–¥–µ–ª–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å

            except TokenError:
                # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã, –µ—Å–ª–∏ refresh –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
                response.delete_cookie('access_token')
                response.delete_cookie('refresh_token')
                return response
    return response
```

---

### üí° **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç**

–ö–∞–∫ –¥–µ–ª–∞—é—Ç –æ–±—ã—á–Ω–æ:

* –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ –ª–æ–≤—è—Ç 401.
* –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç `refresh_token` –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (`/token/refresh/`).
* –ü–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–π `access_token`.
* –ü–æ–≤—Ç–æ—Ä—è—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å.

üí° –ù–æ —Ç–≤–æ—è –∏–¥–µ—è —Å middleware ‚Äî —ç—Ç–æ –∫—Ä—É—Ç–æ, –µ—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç "–±–µ—Å—à–æ–≤–Ω–æ".

---

### üîç –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å

1. **–¢—ã —Ç–æ—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `SimpleJWT` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö?**

   ```python
   REST_FRAMEWORK = {
       'DEFAULT_AUTHENTICATION_CLASSES': (
           'rest_framework_simplejwt.authentication.JWTAuthentication',
       ),
   }
   ```

2. **Middleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `settings.py`?**

   ```python
   MIDDLEWARE = [
       ...
       'les_18_shop.middleware.JWTAuthenticationMiddleware',
   ]
   ```

3. **–¢—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å —Å `httponly=True` –∫—É–∫–∞–º–∏?**
   –ò—Ö –Ω–µ–ª—å–∑—è –≤–∏–¥–µ—Ç—å –≤ `document.cookie`, –Ω–æ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö.

---

### üîê –°–æ–≤–µ—Ç: –ª–æ–≥–∏—Ä—É–π –∫–ª—é—á–µ–≤—ã–µ —à–∞–≥–∏

–ß—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω—è—Ç—å, **—á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `print(...)` –∏–ª–∏ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
print('Access token not valid, trying refresh...')
```

